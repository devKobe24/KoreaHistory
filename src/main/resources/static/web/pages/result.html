<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²°ê³¼ - í•œêµ­ì‚¬ ì•„ë </title>
    <link rel="stylesheet" href="../css/user.css" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‡°ğŸ‡·</text></svg>"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="page-transition">
    <!-- í—¤ë” -->
    <header class="header">
      <nav class="navbar">
        <div class="nav-brand">
          <h1 id="navTitle">ğŸ‡°ğŸ‡· í•œêµ­ì‚¬ ì•„ë </h1>
          <span>í•œêµ­ì‚¬ í•™ìŠµ í”Œë«í¼</span>
        </div>
        <ul class="nav-menu">
          <li><a href="../index.html" class="nav-link">í™ˆ</a></li>
          <li><a href="../index.html#search" class="nav-link">ê²€ìƒ‰</a></li>
          <li><a href="about.html" class="nav-link">ì†Œê°œ</a></li>
        </ul>
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </nav>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="result-main-content">
      <div class="result-container">
        <!-- í˜ì´ì§€ íƒ€ì´í‹€ ì„¹ì…˜ -->
        <div class="result-hero">
          <div class="result-breadcrumb">
            <a href="../index.html">í™ˆ</a>
            <span class="breadcrumb-separator">â€º</span>
            <span id="resultCategory">ê²€ìƒ‰ ê²°ê³¼</span>
          </div>
          <h1 class="result-page-title" id="sectionTitle">ê²°ê³¼ ì œëª©</h1>
          <p class="result-page-description" id="sectionDescription">
            ê´€ë ¨ í•™ìŠµ ìë£Œ ë° ì½˜í…ì¸ ë¥¼ í™•ì¸í•˜ì„¸ìš”
          </p>
        </div>

        <!-- í•„í„° ë° ì •ë ¬ -->
        <div class="result-controls">
          <div class="result-filter-group">
            <button class="filter-pill active" data-filter="all">
              ì „ì²´ <span class="filter-count" id="countAll">0</span>
            </button>
            <button class="filter-pill" data-filter="chapter">
              ì‹œëŒ€ <span class="filter-count" id="countChapter">0</span>
            </button>
            <button class="filter-pill" data-filter="lesson">
              ê°•ì˜ <span class="filter-count" id="countLesson">0</span>
            </button>
            <button class="filter-pill" data-filter="section">
              ì†Œë¶„ë¥˜ <span class="filter-count" id="countSection">0</span>
            </button>
            <button class="filter-pill" data-filter="content">
              ë‚´ìš© <span class="filter-count" id="countContent">0</span>
            </button>
          </div>
          <div class="result-sort">
            <!-- View Switcher -->
            <div class="view-switcher">
              <button class="view-btn active" data-view="grid">
                <span class="view-icon">â–¦</span>
                ê·¸ë¦¬ë“œ
              </button>
              <button class="view-btn" data-view="list">
                <span class="view-icon">â˜°</span>
                ë¦¬ìŠ¤íŠ¸
              </button>
              <button class="view-btn" data-view="timeline">
                <span class="view-icon">â‹®</span>
                íƒ€ì„ë¼ì¸
              </button>
            </div>
            <select id="sortSelect" class="sort-select">
              <option value="date">ìµœì‹ ìˆœ</option>
              <option value="title">ì œëª©ìˆœ</option>
              <option value="relevance">ê´€ë ¨ë„ìˆœ</option>
            </select>
          </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  ê·¸ë¦¬ë“œ -->
        <div class="result-grid" id="resultContentGrid">
          <!-- ë™ì ìœ¼ë¡œ ì½˜í…ì¸ ê°€ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          <div class="result-empty-state">
            <div class="empty-icon">ğŸ”</div>
            <p>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>

        <!-- íƒ€ì„ë¼ì¸ ë·° -->
        <div class="result-timeline-view" id="resultTimelineView">
          <div class="timeline-section">
            <div class="timeline-period">2025</div>
            <div class="timeline-items" id="timelineItems">
              <!-- ë™ì ìœ¼ë¡œ íƒ€ì„ë¼ì¸ ì•„ì´í…œì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
          </div>
        </div>

        <!-- ë¦¬ìŠ¤íŠ¸ ë·° (í…Œì´ë¸” í˜•íƒœ) -->
        <div
          class="result-list-container"
          id="resultListContainer"
          style="display: none"
        >
          <div class="result-table">
            <div class="result-table-header">
              <div class="table-col col-number">#</div>
              <div class="table-col col-thumbnail">ë¯¸ë¦¬ë³´ê¸°</div>
              <div class="table-col col-title">ì œëª©</div>
              <div class="table-col col-category">ë¶„ë¥˜</div>
              <div class="table-col col-date">ë‚ ì§œ</div>
            </div>
            <div class="result-table-body" id="resultTableBody">
              <!-- ë™ì ìœ¼ë¡œ í–‰ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
          </div>
        </div>

        <!-- ê´€ë ¨ í•­ëª© ì„¹ì…˜ -->
        <div
          class="result-related-section"
          id="resultRelatedSection"
          style="display: none"
        >
          <div class="related-header">
            <h2 class="related-title">ê´€ë ¨ í•­ëª©</h2>
            <p class="related-description">
              ì´ ì£¼ì œì™€ ì—°ê´€ëœ ë‹¤ë¥¸ í•™ìŠµ ìë£Œë“¤ì…ë‹ˆë‹¤
            </p>
          </div>
          <div class="related-grid" id="relatedGrid">
            <!-- ë™ì ìœ¼ë¡œ ê´€ë ¨ í•­ëª©ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>ğŸ‡°ğŸ‡· í•œêµ­ì‚¬ ì•„ë </h3>
            <p>í•œêµ­ì‚¬ í•™ìŠµì„ ìœ„í•œ ìµœê³ ì˜ ì˜¨ë¼ì¸ í”Œë«í¼</p>
          </div>
          <div class="footer-section">
            <h4>í•™ìŠµ ìë£Œ</h4>
            <ul>
              <li><a href="../index.html#search">ìë£Œ ê²€ìƒ‰</a></li>
              <li><a href="about.html">í”Œë«í¼ ì†Œê°œ</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>ê¸°ìˆ  ì •ë³´</h4>
            <ul>
              <li>Spring Boot + JPA</li>
              <li>H2 Database</li>
              <li>RESTful API</li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 í•œêµ­ì‚¬ ì•„ë . í•œêµ­ì‚¬ í•™ìŠµì„ ìœ„í•œ ëª¨ë“  ê²ƒ.</p>
        </div>
      </div>
    </footer>

    <!-- ìŠ¤í¬ë¡¤ íˆ¬ íƒ‘ ë²„íŠ¼ -->
    <button class="scroll-to-top" id="scrollToTop">
      <span>â†‘</span>
    </button>

    <script src="../js/user.js"></script>
    <script>
      (function () {
        "use strict";

        try {
          const API_BASE_URL = "/api/v1";
          let currentView = "grid"; // grid or list
          let currentFilter = "all";
          let allResults = [];

          // URL íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
          function getUrlParameter(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
            const results = regex.exec(location.search);
            return results === null
              ? ""
              : decodeURIComponent(results[1].replace(/\+/g, " "));
          }

          // íƒ€ì…ë³„ ì•„ì´ì½˜
          function getTypeIcon(type) {
            const icons = {
              chapter: "ğŸ“š",
              lesson: "ğŸ“–",
              section: "ğŸ“‘",
              subsection: "ğŸ“‹",
              topic: "ğŸ¯",
              keyword: "ğŸ·ï¸",
              content: "ğŸ“„",
            };
            return icons[type] || "ğŸ“";
          }

          // íƒ€ì…ë³„ ë¼ë²¨
          function getTypeLabel(type) {
            const labels = {
              chapter: "ì‹œëŒ€",
              lesson: "ê°•ì˜",
              section: "ì†Œë¶„ë¥˜",
              subsection: "ìƒì„¸ë¶„ë¥˜",
              topic: "ì£¼ì œ",
              keyword: "í‚¤ì›Œë“œ",
              content: "ë‚´ìš©",
            };
            return labels[type] || "í•™ìŠµ ìë£Œ";
          }

          // ì¹´ë“œ ìƒì„±
          function createResultCard(result, index) {
            const type = result.type || "content";
            const card = document.createElement("div");
            card.className = "result-card";
            card.dataset.type = type;
            if (type === "topic" && result.id) {
              card.dataset.topicId = result.id;
            }
            card.style.opacity = "0";
            card.style.transform = "translateY(20px)";

            const icon = getTypeIcon(type);
            const typeLabel = getTypeLabel(type);
            const title = result.title || result.name || "ì œëª© ì—†ìŒ";
            const description = formatDescription(result);

            card.innerHTML = `
              <div class="result-card-header">
                <span class="result-card-icon">${icon}</span>
                <span class="result-card-type">${typeLabel}</span>
              </div>
              <h3 class="result-card-title">${title}</h3>
              <p class="result-card-description">${truncateText(
                description,
                100
              )}</p>
              <div class="result-card-footer">
                <span class="result-card-date">ìµœê·¼ ì—…ë°ì´íŠ¸</span>
                <button class="result-card-action">ìì„¸íˆ ë³´ê¸° â†’</button>
              </div>
            `;

            card.addEventListener("click", () => {
              openDetailPage(result);
            });

            // ì• ë‹ˆë©”ì´ì…˜
            setTimeout(() => {
              card.style.opacity = "1";
              card.style.transform = "translateY(0)";
            }, index * 50);

            return card;
          }

          function formatDescription(result) {
            if (result.type === "topic") {
              const number =
                result.topicNumber ??
                result.topic_number ??
                result.number ??
                result.topic?.topicNumber ??
                result.topic?.topic_number ??
                "";
              const title = result.title || result.name || result.topicTitle || "ì œëª© ì—†ìŒ";
              const subsectionData =
                result.subsection ??
                result.subsectionDto ??
                result.parentSubsection ??
                null;
              const subsectionNumber =
                result.subsectionNumber ??
                result.subsection_number ??
                subsectionData?.subsectionNumber ??
                subsectionData?.subsection_number ??
                "";
              const subsectionTitle =
                result.subsectionTitle ??
                result.subsection_title ??
                subsectionData?.subsectionTitle ??
                subsectionData?.subsection_title ??
                "";

              const topicLabel = number
                ? `Topic: ${number}. ${title}`
                : `Topic: ${title}`;

              const hasSubsectionInfo =
                (subsectionNumber !== undefined &&
                  subsectionNumber !== null &&
                  String(subsectionNumber).trim() !== "") ||
                (subsectionTitle !== undefined &&
                  subsectionTitle !== null &&
                  String(subsectionTitle).trim() !== "");

              if (hasSubsectionInfo) {
                const numberPart =
                  subsectionNumber !== undefined &&
                  subsectionNumber !== null &&
                  String(subsectionNumber).trim() !== ""
                    ? String(subsectionNumber).trim()
                    : "";
                const titlePart =
                  subsectionTitle !== undefined &&
                  subsectionTitle !== null &&
                  String(subsectionTitle).trim() !== ""
                    ? String(subsectionTitle).trim()
                    : "";

                let subsectionLabel = "";
                if (numberPart && titlePart) {
                  subsectionLabel = `${numberPart}. ${titlePart}`;
                } else if (numberPart) {
                  subsectionLabel = `${numberPart}.`;
                } else {
                  subsectionLabel = titlePart;
                }

                return `${topicLabel} - ${subsectionLabel}`;
              }

              return topicLabel;
            }

            return result.description || result.content || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
          }

          // í…Œì´ë¸” í–‰ ìƒì„±
          function createTableRow(result, index) {
            const type = result.type || "content";
            const row = document.createElement("div");
            row.className = "result-table-row";
            row.dataset.type = type;

            const icon = getTypeIcon(type);
            const typeLabel = getTypeLabel(type);
            const title = result.title || result.name || "ì œëª© ì—†ìŒ";

            row.innerHTML = `
              <div class="table-col col-number">${index + 1}</div>
              <div class="table-col col-thumbnail">
                <div class="thumbnail-icon">${icon}</div>
              </div>
              <div class="table-col col-title">${title}</div>
              <div class="table-col col-category">
                <span class="category-badge">${typeLabel}</span>
              </div>
              <div class="table-col col-date">ìµœê·¼</div>
            `;

            row.addEventListener("click", () => {
              openDetailPage(result);
            });

            return row;
          }

          // í…ìŠ¤íŠ¸ ìë¥´ê¸°
          function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + "...";
          }

          // ìƒì„¸ í˜ì´ì§€ ì—´ê¸°
          function openDetailPage(result) {
            const titleValue = result.title || result.name || "ì œëª© ì—†ìŒ";
            const type = result.type || "default";
            const params = new URLSearchParams();
            params.set("title", titleValue);
            params.set("type", type);
            if (result.id !== undefined && result.id !== null) {
              params.set("id", result.id);
            }

            window.location.href = `detail.html?${params.toString()}`;
          }

          // í•„í„° ì ìš©
          function applyFilter(filter) {
            currentFilter = filter;

            // í•„í„° ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll(".filter-pill").forEach((btn) => {
              btn.classList.remove("active");
              if (btn.dataset.filter === filter) {
                btn.classList.add("active");
              }
            });

            // ê²°ê³¼ í•„í„°ë§
            const filteredResults =
              filter === "all"
                ? allResults
                : allResults.filter((r) => r.type === filter);

            displayResults(filteredResults);
          }

          // ê²°ê³¼ í‘œì‹œ
          function displayResults(results) {
            if (results.length === 0) {
              const grid = document.getElementById("resultContentGrid");
              grid.innerHTML = `
                <div class="result-empty-state">
                  <div class="empty-icon">ğŸ˜”</div>
                  <p>ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
              `;
              return;
            }

            // í˜„ì¬ ë·°ì— ë”°ë¼ ì ì ˆí•œ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ
            switch (currentView) {
              case "grid":
                displayGridView(results);
                break;
              case "list":
                displayListView(results);
                break;
              case "timeline":
                displayTimelineView(results);
                break;
            }
          }

          // ê·¸ë¦¬ë“œ ë·° í‘œì‹œ
          function displayGridView(results) {
            const grid = document.getElementById("resultContentGrid");
            if (!grid) return;

            grid.innerHTML = "";
            results.forEach((result, index) => {
              grid.appendChild(createResultCard(result, index));
            });
          }

          // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
          function updateCounts() {
            const counts = {
              all: allResults.length,
              chapter: allResults.filter((r) => r.type === "chapter").length,
              lesson: allResults.filter((r) => r.type === "lesson").length,
              section: allResults.filter((r) => r.type === "section").length,
              content: allResults.filter((r) => r.type === "content").length,
            };

            Object.keys(counts).forEach((key) => {
              const el = document.getElementById(
                "count" + key.charAt(0).toUpperCase() + key.slice(1)
              );
              if (el) el.textContent = counts[key];
            });
          }

          // í˜ì´ì§€ ì´ˆê¸°í™”
          function setupPage() {
            try {
              const title = getUrlParameter("title");
              const type = getUrlParameter("type");
              const id = getUrlParameter("id");

              console.log("Title:", title, "Type:", type, "ID:", id);

              if (title) {
                document.title = title + " - í•œêµ­ì‚¬ ì•„ë ";

                const navTitle = document.getElementById("navTitle");
                if (navTitle) navTitle.textContent = "ğŸ‡°ğŸ‡· " + title;

                const sectionTitle = document.getElementById("sectionTitle");
                if (sectionTitle) sectionTitle.textContent = title;

                const categoryEl = document.getElementById("resultCategory");
                if (categoryEl && type)
                  categoryEl.textContent = getTypeLabel(type);
              }

              // ì‹¤ì œ ë°ì´í„° ë¡œë“œ (idê°€ ìˆìœ¼ë©´ idë¡œ, ì—†ìœ¼ë©´ titleë¡œ ê²€ìƒ‰)
              loadResultData(type, title, id);

              // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
              setupEventListeners();
            } catch (error) {
              console.error("Error in setupPage:", error);
            }
          }

          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          function setupEventListeners() {
            // í•„í„° ë²„íŠ¼
            document.querySelectorAll(".filter-pill").forEach((btn) => {
              btn.addEventListener("click", () => {
                applyFilter(btn.dataset.filter);
              });
            });

            // ë·° ì „í™˜ ë²„íŠ¼
            document.querySelectorAll(".view-btn").forEach((btn) => {
              btn.addEventListener("click", () => {
                switchView(btn.dataset.view);
              });
            });

            // ì •ë ¬
            const sortSelect = document.getElementById("sortSelect");
            if (sortSelect) {
              sortSelect.addEventListener("change", (e) => {
                sortResults(e.target.value);
              });
            }
          }

          // ë·° ì „í™˜
          function switchView(viewType) {
            currentView = viewType;

            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll(".view-btn").forEach((btn) => {
              btn.classList.remove("active");
              if (btn.dataset.view === viewType) {
                btn.classList.add("active");
              }
            });

            // ë·° ì „í™˜
            const grid = document.getElementById("resultContentGrid");
            const list = document.getElementById("resultListContainer");
            const timeline = document.getElementById("resultTimelineView");

            grid.style.display = "none";
            list.style.display = "none";
            timeline.classList.remove("active");

            const filteredResults =
              currentFilter === "all"
                ? allResults
                : allResults.filter((r) => r.type === currentFilter);

            switch (viewType) {
              case "grid":
                grid.style.display = "grid";
                displayResults(filteredResults);
                break;
              case "list":
                list.style.display = "block";
                displayListView(filteredResults);
                break;
              case "timeline":
                timeline.classList.add("active");
                displayTimelineView(filteredResults);
                break;
            }
          }

          // íƒ€ì„ë¼ì¸ ë·° í‘œì‹œ
          function displayTimelineView(results) {
            const timelineItems = document.getElementById("timelineItems");
            if (!timelineItems) return;

            timelineItems.innerHTML = "";

            results.forEach((result, index) => {
              const item = createTimelineItem(result, index);
              timelineItems.appendChild(item);
            });
          }

          // íƒ€ì„ë¼ì¸ ì•„ì´í…œ ìƒì„±
          function createTimelineItem(result, index) {
            const type = result.type || "content";
            const item = document.createElement("div");
            item.className = "timeline-item";
            item.dataset.type = type;

            const icon = getTypeIcon(type);
            const typeLabel = getTypeLabel(type);
            const title = result.title || result.name || "ì œëª© ì—†ìŒ";
            const description =
              result.description || result.content || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";

            // ë‚ ì§œ ìƒì„± (ë”ë¯¸)
            const day = String(index + 1).padStart(2, "0");
            const month = "10";

            item.innerHTML = `
              <div class="timeline-thumbnail">
                <span>${icon}</span>
              </div>
              <div class="timeline-date">
                <div class="timeline-day">${day}</div>
                <div class="timeline-month">${month}.23</div>
              </div>
              <div class="timeline-content">
                <h3 class="timeline-title">${title}</h3>
                <div class="timeline-badges">
                  <span class="timeline-badge">${typeLabel}</span>
                </div>
                <p class="timeline-description">${truncateText(
                  description,
                  150
                )}</p>
                <div class="timeline-location">í•œêµ­ì‚¬ ì•„ë </div>
              </div>
            `;

            item.addEventListener("click", () => {
              openDetailPage(result);
            });

            return item;
          }

          // ë¦¬ìŠ¤íŠ¸ ë·° í‘œì‹œ
          function displayListView(results) {
            const tableBody = document.getElementById("resultTableBody");
            if (!tableBody) return;

            tableBody.innerHTML = "";

            results.forEach((result, index) => {
              tableBody.appendChild(createTableRow(result, index));
            });
          }

          // ì •ë ¬
          function sortResults(sortType) {
            let sorted = [...allResults];

            switch (sortType) {
              case "title":
                sorted.sort((a, b) => {
                  const titleA = a.title || a.name || "";
                  const titleB = b.title || b.name || "";
                  return titleA.localeCompare(titleB);
                });
                break;
              case "date":
                // ë‚ ì§œ ì •ë ¬ ë¡œì§
                break;
              case "relevance":
                // ê´€ë ¨ë„ ì •ë ¬ ë¡œì§
                break;
            }

            displayResults(
              sorted.filter(
                (r) => currentFilter === "all" || r.type === currentFilter
              )
            );
          }

          // ì‹¤ì œ ë°ì´í„° ë¡œë“œ
          async function loadResultData(type, title, id) {
            try {
              console.log("Loading data for type:", type, "title:", title, "id:", id);
              
              // ë¡œë”© ìƒíƒœ í‘œì‹œ
              const contentGrid = document.getElementById("resultContentGrid");
              if (contentGrid) {
                contentGrid.innerHTML = '<div class="result-empty-state"><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
              }

              let response;
              let data = [];

              // íƒ€ì…ì— ë”°ë¼ ì ì ˆí•œ API í˜¸ì¶œ
              switch (type) {
                case "chapter":
                  // Chapterì˜ ëª¨ë“  í•˜ìœ„ í•­ëª©ë“¤ì„ ì¬ê·€ì ìœ¼ë¡œ ìˆ˜ì§‘
                  response = await fetch(`${API_BASE_URL}/chapters/search/all`);
                  if (response.ok) {
                    const chapters = await response.json();
                    console.log("Chapters received:", chapters);
                    // idê°€ ìˆìœ¼ë©´ idë¡œ ì°¾ê³ , ì—†ìœ¼ë©´ titleë¡œ ì°¾ê¸°
                    const chapter = id 
                      ? chapters.find(c => c.id === parseInt(id))
                      : chapters.find(c => c.chapterTitle === title);
                    console.log("Found chapter:", chapter);
                    if (chapter) {
                      const collectedData = [];
                      
                      // Chapter ìì²´ ì¶”ê°€
                      collectedData.push({
                        type: "chapter",
                        id: chapter.id,
                        title: chapter.chapterTitle,
                        description: `Chapter ${chapter.chapterNumber}: ${chapter.chapterTitle}`,
                        number: chapter.chapterNumber
                      });
                      
                      // Lesson, Section, Subsection, Topicì„ ì¬ê·€ì ìœ¼ë¡œ ìˆ˜ì§‘
                      if (chapter.lessons && chapter.lessons.length > 0) {
                        for (const lesson of chapter.lessons) {
                          // Lesson ì¶”ê°€
                          collectedData.push({
                            type: "lesson",
                            id: lesson.id,
                            title: lesson.lessonTitle,
                            description: `Lesson ${lesson.lessonNumber}: ${lesson.lessonTitle}`,
                            number: lesson.lessonNumber
                          });
                          
                          // Section ìˆ˜ì§‘
                          if (lesson.sections && lesson.sections.length > 0) {
                            for (const section of lesson.sections) {
                              // Section ì¶”ê°€
                              collectedData.push({
                                type: "section",
                                id: section.id,
                                title: section.sectionTitle,
                                description: `Section ${section.sectionNumber}: ${section.sectionTitle}`,
                                number: section.sectionNumber
                              });
                              
                              // Subsection ìˆ˜ì§‘
                              if (section.subsections && section.subsections.length > 0) {
                                for (const subsection of section.subsections) {
                                  // Subsection ì¶”ê°€
                                  collectedData.push({
                                    type: "subsection",
                                    id: subsection.id,
                                    title: subsection.subsectionTitle,
                                    description: `Subsection ${subsection.subsectionNumber}: ${subsection.subsectionTitle}`,
                                    number: subsection.subsectionNumber
                                  });
                                  
                                  // Topic ìˆ˜ì§‘
                                  if (subsection.topics && subsection.topics.length > 0) {
                                    for (const topic of subsection.topics) {
                                      // Topic ì¶”ê°€
                                      collectedData.push({
                                        type: "topic",
                                        id: topic.id,
                                        title: topic.topicTitle,
                                        description: `Topic ${topic.topicNumber}: ${topic.topicTitle}`,
                            number: topic.topicNumber,
                            subsectionNumber:
                              topic.subsectionNumber ??
                              topic.subsection?.subsectionNumber ??
                              subsection.subsectionNumber,
                            subsectionTitle:
                              topic.subsectionTitle ??
                              topic.subsection?.subsectionTitle ??
                              subsection.subsectionTitle,
                            subsection: topic.subsection
                                      });
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                      
                      // Keywordì™€ Content ì¶”ê°€ ê²€ìƒ‰
                      try {
                        const keywordResponse = await fetch(`${API_BASE_URL}/keywords/search/all`);
                        if (keywordResponse.ok) {
                          const allKeywords = await keywordResponse.json();
                          allKeywords.forEach(keyword => {
                            collectedData.push({
                              type: "keyword",
                              id: keyword.id,
                              title: keyword.keywords ? keyword.keywords.join(", ") : "í‚¤ì›Œë“œ",
                              description: "í‚¤ì›Œë“œ ê·¸ë£¹"
                            });
                          });
                        }
                      } catch (e) {
                        console.warn("Failed to load keywords:", e);
                      }
                      
                      try {
                        const contentResponse = await fetch(`${API_BASE_URL}/contents/search/all`);
                        if (contentResponse.ok) {
                          const allContents = await contentResponse.json();
                          allContents.forEach(content => {
                            collectedData.push({
                              type: "content",
                              id: content.id,
                              title: content.contentTitle || "ì œëª© ì—†ìŒ",
                              description: content.contentNumber !== null && content.contentNumber !== undefined
                                ? `Content ${content.contentNumber}: ${content.contentTitle || "ì œëª© ì—†ìŒ"}`
                                : content.contentTitle || "ìƒì„¸ ë‚´ìš©"
                            });
                          });
                        }
                      } catch (e) {
                        console.warn("Failed to load contents:", e);
                      }
                      
                      data = collectedData;
                      console.log("Chapter collected data:", data);
                    }
                  }
                  break;

                case "lesson":
                  // Lessonì˜ í•˜ìœ„ Sectionë“¤ì„ ê°€ì ¸ì˜¤ê¸°
                  let lesson = null;
                  
                  // ë¨¼ì € Chapter APIì—ì„œ ì°¾ê¸°
                  const chaptersResponse = await fetch(`${API_BASE_URL}/chapters/search/all`);
                  if (chaptersResponse.ok) {
                    const chapters = await chaptersResponse.json();
                    for (const chapter of chapters) {
                      if (chapter.lessons) {
                        const foundLesson = chapter.lessons.find(l => l.lessonTitle === title);
                        if (foundLesson) {
                          lesson = foundLesson;
                          break;
                        }
                      }
                    }
                  }
                  
                  // Chapterì—ì„œ ëª» ì°¾ìœ¼ë©´ ì§ì ‘ API í˜¸ì¶œ
                  if (!lesson) {
                    const lessonsResponse = await fetch(`${API_BASE_URL}/lessons/search/all`);
                    if (lessonsResponse.ok) {
                      const lessons = await lessonsResponse.json();
                      lesson = lessons.find(l => l.lessonTitle === title);
                    }
                  }
                  
                  if (lesson) {
                    // Lesson ìì²´ë¥¼ ë¨¼ì € ì¶”ê°€
                    data = [{
                      type: "lesson",
                      id: lesson.id,
                      title: lesson.lessonTitle,
                      description: `Lesson ${lesson.lessonNumber}: ${lesson.lessonTitle}`,
                      number: lesson.lessonNumber
                    }];
                    
                    // Lessonì˜ í•˜ìœ„ Sectionë“¤ë„ ì¶”ê°€
                    if (lesson.sections && lesson.sections.length > 0) {
                      const sections = lesson.sections.map(section => ({
                        type: "section",
                        id: section.id,
                        title: section.sectionTitle,
                        description: `Section ${section.sectionNumber}: ${section.sectionTitle}`,
                        number: section.sectionNumber
                      }));
                      data = data.concat(sections);
                    }
                  }
                  break;

                case "section":
                  // Sectionì˜ í•˜ìœ„ Subsectionë“¤ì„ ê°€ì ¸ì˜¤ê¸°
                  let section = null;
                  
                  // Chapter APIë¥¼ í†µí•´ ì°¾ê¸°
                  const chaptersResponseForSection = await fetch(`${API_BASE_URL}/chapters/search/all`);
                  if (chaptersResponseForSection.ok) {
                    const chapters = await chaptersResponseForSection.json();
                    for (const chapter of chapters) {
                      if (chapter.lessons) {
                        for (const lesson of chapter.lessons) {
                          if (lesson.sections) {
                            const foundSection = lesson.sections.find(s => s.sectionTitle === title);
                            if (foundSection) {
                              section = foundSection;
                              break;
                            }
                          }
                        }
                        if (section) break;
                      }
                    }
                  }
                  
                  if (section) {
                    // Section ìì²´ë¥¼ ë¨¼ì € ì¶”ê°€
                    data = [{
                      type: "section",
                      id: section.id,
                      title: section.sectionTitle,
                  description: `Section ${section.sectionNumber}: ${section.sectionTitle}`,
                      number: section.sectionNumber
                    }];
                    
                    // Sectionì˜ í•˜ìœ„ Subsectionë“¤ë„ ì¶”ê°€
                    if (section.subsections && section.subsections.length > 0) {
                      const subsections = section.subsections.map(subsection => ({
                        type: "subsection",
                        id: subsection.id,
                        title: subsection.subsectionTitle,
                        description: `Subsection ${subsection.subsectionNumber}: ${subsection.subsectionTitle}`,
                        number: subsection.subsectionNumber
                      }));
                      data = data.concat(subsections);
                    }
                  }
                  break;

                case "subsection":
                  // Subsectionì˜ í•˜ìœ„ Topicë“¤ì„ ê°€ì ¸ì˜¤ê¸°
                  let subsection = null;
                  
                  // Chapter APIë¥¼ í†µí•´ ì°¾ê¸°
                  const chaptersResponseForSubsection = await fetch(`${API_BASE_URL}/chapters/search/all`);
                  if (chaptersResponseForSubsection.ok) {
                    const chapters = await chaptersResponseForSubsection.json();
                    for (const chapter of chapters) {
                      if (chapter.lessons) {
                        for (const lesson of chapter.lessons) {
                          if (lesson.sections) {
                            for (const section of lesson.sections) {
                              if (section.subsections) {
                                const foundSubsection = section.subsections.find(sub => sub.subsectionTitle === title);
                                if (foundSubsection) {
                                  subsection = foundSubsection;
                                  break;
                                }
                              }
                            }
                            if (subsection) break;
                          }
                        }
                        if (subsection) break;
                      }
                    }
                  }
                  
                  if (subsection) {
                    // Subsection ìì²´ë¥¼ ë¨¼ì € ì¶”ê°€
                    data = [{
                      type: "subsection",
                      id: subsection.id,
                      title: subsection.subsectionTitle,
                      description: `Subsection ${subsection.subsectionNumber}: ${subsection.subsectionTitle}`,
                      number: subsection.subsectionNumber
                    }];
                    
                    // Subsectionì˜ í•˜ìœ„ Topicë“¤ë„ ì¶”ê°€
                    if (subsection.topics && subsection.topics.length > 0) {
                      const topics = subsection.topics.map(topic => ({
                        type: "topic",
                        id: topic.id,
                        title: topic.topicTitle,
                        description: `Topic ${topic.topicNumber}: ${topic.topicTitle}`,
                        number: topic.topicNumber,
                        subsectionNumber:
                          topic.subsectionNumber ??
                          topic.subsection?.subsectionNumber ??
                          subsection.subsectionNumber,
                        subsectionTitle:
                          topic.subsectionTitle ??
                          topic.subsection?.subsectionTitle ??
                          subsection.subsectionTitle,
                        subsection: topic.subsection
                      }));
                      data = data.concat(topics);
                    }
                  }
                  break;

                case "keyword":
                  // Keywordë¥¼ ì°¾ì•„ì„œ í‘œì‹œ
                  try {
                    // ëª¨ë“  keywordsë¥¼ ê°€ì ¸ì™€ì„œ titleê³¼ ë§¤ì¹­ë˜ëŠ” keyword ì°¾ê¸°
                    const keywordsResponse = await fetch(`${API_BASE_URL}/keywords/search/all`);
                    if (keywordsResponse.ok) {
                      const allKeywords = await keywordsResponse.json();
                      
                      // titleì„ ì •ê·œí™” (ê³µë°± ì œê±° í›„ ì •ë ¬)
                      const normalizeTitle = (str) => {
                        if (!str) return "";
                        return str.split(",")
                          .map(k => k.trim())
                          .filter(k => k.length > 0)
                          .sort()
                          .join(", ");
                      };
                      
                      const normalizedTitle = normalizeTitle(title);
                      
                      // keywordì˜ keywords ë°°ì—´ì„ joiní•œ ê°’ê³¼ ë¹„êµ
                      const foundKeyword = allKeywords.find(k => {
                        if (!k.keywords || k.keywords.length === 0) {
                          return k.keywordTitle === title;
                        }
                        
                        // keywordì˜ keywords ë°°ì—´ì„ ì •ë ¬í•˜ê³  join
                        const keywordString = k.keywords
                          .map(kw => kw.trim())
                          .filter(kw => kw.length > 0)
                          .sort()
                          .join(", ");
                        
                        // ì •ê·œí™”ëœ titleê³¼ ë¹„êµ
                        const keywordsMatch = keywordString === normalizedTitle;
                        const titleMatch = k.keywordTitle === title;
                        
                        return keywordsMatch || titleMatch;
                      });
                      
                      if (foundKeyword) {
                        // Keyword ìì²´ë¥¼ ì¶”ê°€
                        data = [{
                          type: "keyword",
                          id: foundKeyword.id,
                          title: foundKeyword.keywords ? foundKeyword.keywords.join(", ") : (foundKeyword.keywordTitle || "í‚¤ì›Œë“œ"),
                          description: foundKeyword.keywordTitle || "í‚¤ì›Œë“œ ê·¸ë£¹",
                          number: foundKeyword.keywordNumber
                        }];
                      }
                    }
                  } catch (error) {
                    console.error("Error loading keyword:", error);
                  }
                  break;

                case "content":
                  // Contentë¥¼ ì°¾ì•„ì„œ í‘œì‹œ
                  try {
                    // content_titleë¡œ ê²€ìƒ‰
                    const contentResponse = await fetch(`${API_BASE_URL}/search/contents?detail=${encodeURIComponent(title)}`);
                    if (contentResponse.ok) {
                      const contents = await contentResponse.json();
                      // titleì´ content_titleê³¼ ì¼ì¹˜í•˜ëŠ” content ì°¾ê¸°
                      const foundContent = contents.find(c => c.contentTitle === title);
                      
                      if (foundContent) {
                        // Content ìì²´ë¥¼ ì¶”ê°€
                        data = [{
                          type: "content",
                          id: foundContent.id,
                          title: foundContent.contentTitle || "ì œëª© ì—†ìŒ",
                          description: foundContent.contentNumber !== null && foundContent.contentNumber !== undefined
                            ? `Content ${foundContent.contentNumber}: ${foundContent.contentTitle || "ì œëª© ì—†ìŒ"}`
                            : foundContent.contentTitle || "ìƒì„¸ ë‚´ìš©",
                          number: foundContent.contentNumber
                        }];
                      }
                    }
                  } catch (error) {
                    console.error("Error loading content:", error);
                  }
                  break;

                default:
                  // ê¸°ë³¸ì ìœ¼ë¡œ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰
                  const searchPromises = [
                    fetch(`${API_BASE_URL}/search/chapters?title=${encodeURIComponent(title)}`).then(r => r.ok ? r.json() : []),
                    fetch(`${API_BASE_URL}/search/lessons?title=${encodeURIComponent(title)}`).then(r => r.ok ? r.json() : []),
                    fetch(`${API_BASE_URL}/search/sections?title=${encodeURIComponent(title)}`).then(r => r.ok ? r.json() : []),
                    fetch(`${API_BASE_URL}/search/subsections?title=${encodeURIComponent(title)}`).then(r => r.ok ? r.json() : []),
                    fetch(`${API_BASE_URL}/search/topics?title=${encodeURIComponent(title)}`).then(r => r.ok ? r.json() : []),
                    fetch(`${API_BASE_URL}/search/keywords?keyword=${encodeURIComponent(title)}`).then(r => r.ok ? r.json() : []),
                    fetch(`${API_BASE_URL}/search/contents?detail=${encodeURIComponent(title)}`).then(r => r.ok ? r.json() : [])
                  ];

                  const results = await Promise.all(searchPromises);
                  data = [
                    ...results[0].map(ch => ({ type: "chapter", id: ch.id, title: ch.chapterTitle, description: `Chapter ${ch.chapterNumber}: ${ch.chapterTitle}` })),
                    ...results[1].map(le => ({ type: "lesson", id: le.id, title: le.lessonTitle, description: `Lesson ${le.lessonNumber}: ${le.lessonTitle}` })),
                    ...results[2].map(se => ({ type: "section", id: se.id, title: se.sectionTitle, description: `Section ${se.sectionNumber}: ${se.sectionTitle}` })),
                    ...results[3].map(su => ({ type: "subsection", id: su.id, title: su.subsectionTitle, description: `Subsection ${su.subsectionNumber}: ${su.subsectionTitle}` })),
                    ...results[4].map(to => ({
                      type: "topic",
                      id: to.id,
                      title: to.topicTitle,
                      description: `Topic ${to.topicNumber}: ${to.topicTitle}`,
                      number: to.topicNumber,
                      topicNumber: to.topicNumber,
                      topicTitle: to.topicTitle,
                      subsectionNumber:
                        to.subsection?.subsectionNumber ??
                        to.subsectionNumber ??
                        to.parentSubsection?.subsectionNumber ??
                        "",
                      subsectionTitle:
                        to.subsection?.subsectionTitle ??
                        to.subsectionTitle ??
                        to.parentSubsection?.subsectionTitle ??
                        "",
                      subsection: to.subsection ?? to.parentSubsection ?? null
                    })),
                    ...results[5].map(ke => ({ type: "keyword", id: ke.id, title: ke.keywords ? ke.keywords.join(", ") : "í‚¤ì›Œë“œ", description: "í‚¤ì›Œë“œ ê·¸ë£¹" })),
                    ...results[6].map(co => ({ 
                      type: "content", 
                      id: co.id, 
                      title: co.contentTitle || "ì œëª© ì—†ìŒ", 
                      description: co.contentNumber !== null && co.contentNumber !== undefined
                        ? `Content ${co.contentNumber}: ${co.contentTitle || "ì œëª© ì—†ìŒ"}`
                        : co.contentTitle || "ìƒì„¸ ë‚´ìš©"
                    }))
                  ];
                  break;
              }

              // ë°ì´í„° ì²˜ë¦¬
              console.log("Final data:", data);
              if (data && data.length > 0) {
                allResults = data;
                console.log("Setting allResults:", allResults);
                updateCounts();
                displayResults(allResults);
              } else {
                // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš°
                console.warn("No data found for type:", type, "title:", title);
                if (contentGrid) {
                  contentGrid.innerHTML = '<div class="result-empty-state"><p>ê´€ë ¨ ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                }
              }
            } catch (error) {
              console.error("Error loading result data:", error);
              const contentGrid = document.getElementById("resultContentGrid");
              if (contentGrid) {
                contentGrid.innerHTML = '<div class="result-empty-state"><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p></div>';
              }
            }
          }

          // ì´ˆê¸°í™” ì‹¤í–‰
          function init() {
            if (document.readyState === "loading") {
              document.addEventListener("DOMContentLoaded", function () {
                setupPage();
                document.body.classList.add("loaded");
              });
            } else {
              setupPage();
              document.body.classList.add("loaded");
            }
          }

          init();
        } catch (error) {
          console.error("Fatal error in result page script:", error);
          document.body.style.display = "block";
        }
      })();
    </script>
  </body>
</html>
